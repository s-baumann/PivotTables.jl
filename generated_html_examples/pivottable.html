<!DOCTYPE html>
<html>
<head>
    <title>PivotTables.jl</title>
    <meta charset="UTF-8">
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: Arial, sans-serif; 
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #$div_id { 
            width: 100%; 
            height: 600px; 
        }
    </style>

    <!-- external libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/d3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/c3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/export_renderers.min.js"></script>
</head>

<body>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
// Centralized data loading function
// This function parses CSV data from a hidden div and returns a Promise
// Usage: loadDataset('dataLabel').then(function(data) { /* use data */ });
function loadDataset(dataLabel) {
    return new Promise(function(resolve, reject) {
        var csvText = document.getElementById(dataLabel).textContent;
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.errors.length > 0) {
                    console.error('CSV parsing errors:', results.errors);
                    reject(results.errors);
                } else {
                    resolve(results.data);
                }
            },
            error: function(error) {
                console.error('CSV parsing error:', error);
                reject(error);
            }
        });
    });
}

$(function(){

    $("#Returns_Over_Last_Few_Days").pivotUI(
                        $.csv.toArrays($("#stockReturns").text()),
                        $.extend({
                            renderers: $.extend(
                                $.pivotUtilities.renderers,
                                $.pivotUtilities.c3_renderers,
                                $.pivotUtilities.d3_renderers,
                                $.pivotUtilities.export_renderers
                                ),
                            hiddenAttributes: [""]
                        }, {"rendererName":"Heatmap","rows":["Symbol"],"aggregatorName":"Average","vals":["Return"],"rendererOptions":{ heatmap: { colorScaleGenerator: function(values) { return Plotly.d3.scale.linear().domain([-2.5, -1.0, 0.0, 1.0, 2.5]).range(["#FF9999", "#FFFF99", "#FFFFFF", "#99FF99", "#99CCFF"]).clamp(true)}}},"cols":["Date"],"exclusions":{"Symbol":["MSFT"]}})
                    );
    // Configuration
    const X_COL = 'x';
    const Y_COL = 'y';
    const COLOR_COL = 'color';
    const FILTER_COLS = ['categ22', 'categ'];
    const COLOR_MAP = {'A': '#636efa', 'B': '#EF553B'};
    const X_LABEL = 'This is the x axis';
    const Y_LABEL = 'This is the y axis';
                
    let allData = [];

    // Make it global so inline onchange can see it
    window.updateChart = function() {
        const filters = {};
        FILTER_COLS.forEach(col => {
            const select = document.getElementById(col + '_select');
            if (select) {
                filters[col] = select.value;
            }
        });

        const filteredData = allData.filter(row => {
            for (let col in filters) {
                if (String(row[col]) !== String(filters[col])) {
                    return false;
                }
            }
            return true;
        });

        const groupedData = {};
        filteredData.forEach(row => {
            const colorVal = row[COLOR_COL];
            if (!groupedData[colorVal]) {
                groupedData[colorVal] = [];
            }
            groupedData[colorVal].push(row);
        });

        const traces = [];
        for (let colorVal in groupedData) {
            const group = groupedData[colorVal];
            group.sort((a, b) => a[X_COL] - b[X_COL]);

            traces.push({
                x: group.map(row => row[X_COL]),
                y: group.map(row => row[Y_COL]),
                type: 'scatter',
                mode: 'lines+markers',
                name: colorVal,
                line: {
                    color: COLOR_MAP[colorVal] || '#000000',
                    width: 1
                },
                marker: { size: 1 }
            });
        }
        
        // Layout
        const layout = {
            xaxis: { title: X_LABEL || X_COL },
            yaxis: { title: Y_LABEL || Y_COL },
            hovermode: 'closest',
            showlegend: true
        };
        
        // Plot
        Plotly.newPlot('pchart', traces, layout, {responsive: true});
    };

    // Load and parse CSV data using centralized parser
    loadDataset('df').then(function(data) {
        allData = data;
        updateChart();
    }).catch(function(error) {
        console.error('Error loading data for chart pchart:', error);
    });
    $("#Correlation_Matrix").pivotUI(
                        $.csv.toArrays($("#correlations").text()),
                        $.extend({
                            renderers: $.extend(
                                $.pivotUtilities.renderers,
                                $.pivotUtilities.c3_renderers,
                                $.pivotUtilities.d3_renderers,
                                $.pivotUtilities.export_renderers
                                ),
                            hiddenAttributes: [""]
                        }, {"rendererName":"Heatmap","rows":["Symbol1"],"aggregatorName":"Average","vals":["Correlation"],"rendererOptions":{ heatmap: { colorScaleGenerator: function(values) { return Plotly.d3.scale.linear().domain([-1.0, 0.0, 1.0]).range(["#FF4545", "#ffffff", "#4F92FF"]).clamp(true)}}},"cols":["Symbol2"]})
                    );
    // Load and parse CSV data using centralized parser
    loadDataset('subframe').then(function(data3d) {
        // ========== 3D SURFACE PLOT CONFIGURATION ==========
        // Define your column names here
        const x = 'x';
        const y = 'y';
        const z = 'z';
        const group = 'group';
        // ===================================================
                
                // Get unique groups
                const uniqueGroups = [...new Set(data3d.map(row => row[group]))].sort();
                
                // Define a set of distinct color gradients
                const colorGradients = [
                    // Blue gradient
                    [[0, 'rgb(8,48,107)'], [0.25, 'rgb(33,102,172)'], [0.5, 'rgb(67,147,195)'], [0.75, 'rgb(146,197,222)'], [1, 'rgb(209,229,240)']],
                    // Red-Orange gradient
                    [[0, 'rgb(127,0,0)'], [0.25, 'rgb(189,0,38)'], [0.5, 'rgb(227,74,51)'], [0.75, 'rgb(252,141,89)'], [1, 'rgb(253,204,138)']],
                    // Green gradient
                    [[0, 'rgb(0,68,27)'], [0.25, 'rgb(0,109,44)'], [0.5, 'rgb(35,139,69)'], [0.75, 'rgb(116,196,118)'], [1, 'rgb(199,233,192)']],
                    // Purple gradient
                    [[0, 'rgb(63,0,125)'], [0.25, 'rgb(106,81,163)'], [0.5, 'rgb(158,154,200)'], [0.75, 'rgb(188,189,220)'], [1, 'rgb(218,218,235)']],
                    // Yellow-Orange gradient
                    [[0, 'rgb(102,37,6)'], [0.25, 'rgb(153,52,4)'], [0.5, 'rgb(217,95,14)'], [0.75, 'rgb(254,153,41)'], [1, 'rgb(254,217,142)']],
                    // Teal gradient
                    [[0, 'rgb(1,70,54)'], [0.25, 'rgb(1,102,94)'], [0.5, 'rgb(2,129,138)'], [0.75, 'rgb(54,175,172)'], [1, 'rgb(178,226,226)']],
                    // Pink-Magenta gradient
                    [[0, 'rgb(73,0,106)'], [0.25, 'rgb(123,50,148)'], [0.5, 'rgb(194,165,207)'], [0.75, 'rgb(231,212,232)'], [1, 'rgb(247,242,247)']],
                    // Brown gradient
                    [[0, 'rgb(84,48,5)'], [0.25, 'rgb(140,81,10)'], [0.5, 'rgb(191,129,45)'], [0.75, 'rgb(223,194,125)'], [1, 'rgb(246,232,195)']],
                ];
                
                // Function to create z matrix for a group
                function createSurface(groupData, colorscale, name) {
                    const xVals = [...new Set(groupData.map(row => row[x]))].sort((a,b) => a-b);
                    const yVals = [...new Set(groupData.map(row => row[y]))].sort((a,b) => a-b);
                    
                    const zMatrix = [];
                    for (let i = 0; i < yVals.length; i++) {
                        zMatrix[i] = [];
                        for (let j = 0; j < xVals.length; j++) {
                            const point = groupData.find(row => row[x] === xVals[j] && row[y] === yVals[i]);
                            zMatrix[i][j] = point ? point[z] : null;
                        }
                    }
                    
                    return {
                        z: zMatrix,
                        x: xVals,
                        y: yVals,
                        type: 'surface',
                        name: name,
                        colorscale: colorscale,
                        showscale: false
                    };
                }
            
            // Create a surface for each group
            const plotData = uniqueGroups.map((grp, index) => {
                const groupData = data3d.filter(row => row[group] === grp);
                const colorscale = colorGradients[index % colorGradients.length];
                return createSurface(groupData, colorscale, `Group ${grp}`);
            });
            
            const layout = {
                title: 'threeD',
                autosize: true,
                height: 600,
                scene: {
                    xaxis: { title: 'X directions' },
                    yaxis: { title: 'Y dim' },
                    zaxis: { title: 'Z directions' }
                },
                showlegend: false,
            };
            
        Plotly.newPlot('threeD', plotData, layout);
    }).catch(function(error) {
        console.error('Error loading data for chart threeD:', error);
    });




});
</script>

<!-- DATASETS -->

<div id="stockReturns" style="display: none;">Symbol,Date,Return
RTX,2023-01-01,10.01
RTX,2023-01-02,-10.005
RTX,2023-01-03,-0.5
GOOG,2023-01-01,1.0
GOOG,2023-01-02,0.01
GOOG,2023-01-03,-0.003
MSFT,2023-01-01,0.008
MSFT,2023-01-02,0.004
MSFT,2023-01-03,-0.002
</div><div id="subframe" style="display: none;">x,y,group,z
1,1,A,0.15594369476537437
2,1,A,-0.6172728764571667
3,1,A,-0.9997860728793259
4,1,A,-0.5557653904191477
5,1,A,0.37706981246168597
6,1,A,0.9799824974549554
1,2,A,-0.6172728764571667
2,2,A,-0.9513631281258474
3,2,A,-0.894288058558276
4,2,A,-0.2379483919805909
5,2,A,0.6231593449762197
6,2,A,0.9991443830469295
1,3,A,-0.9997860728793259
2,3,A,-0.894288058558276
3,3,A,-0.4526618572923528
4,3,A,0.28366218546322625
5,3,A,0.8994733999984659
6,3,A,0.9110310531896002
1,4,A,-0.5557653904191477
2,4,A,-0.2379483919805909
3,4,A,0.28366218546322625
4,4,A,0.8101836031147954
5,4,A,0.9928159447966954
6,4,A,0.5995022633598608
1,5,A,0.37706981246168597
2,5,A,0.6231593449762197
3,5,A,0.8994733999984659
4,5,A,0.9928159447966954
5,5,A,0.7053479063084421
6,5,A,0.04371801995456107
1,6,A,0.9799824974549554
2,6,A,0.9991443830469295
3,6,A,0.9110310531896002
4,6,A,0.5995022633598608
5,6,A,0.04371801995456107
6,6,A,-0.5901944859052752
1,1,B,-0.8440563052346256
2,1,B,-1.6172728764571667
3,1,B,-1.999786072879326
4,1,B,-1.5557653904191477
5,1,B,-0.622930187538314
6,1,B,-0.02001750254504464
1,2,B,-1.1605565385746905
2,2,B,-1.769905729749893
3,2,B,-1.9847209431240276
4,2,B,-1.4526618572923529
5,2,B,-0.5348859483071466
6,2,B,-0.007045023716309329
1,3,B,-1.4161468365471424
2,3,B,-1.8795687341082288
3,3,B,-1.9484431958418278
4,3,B,-1.346174157871352
5,3,B,-0.45271768395849554
6,3,B,-0.0007290466739067192
1,4,B,-1.6172728764571667
2,4,B,-1.9513631281258474
3,4,B,-1.894288058558276
4,4,B,-1.237948391980591
5,4,B,-0.3768406550237803
6,4,B,-0.0008556169530704594
1,5,B,-1.769905729749893
2,5,B,-1.9899924966004454
3,5,B,-1.8252990620752587
4,5,B,-1.1294490013073428
5,5,B,-0.3075808884062521
6,5,B,-0.007184055203304562
1,6,B,-1.8795687341082288
2,6,B,-1.999786072879326
3,6,B,-1.7442462713722906
4,6,B,-1.021971452410018
5,6,B,-0.24518280412638171
6,6,B,-0.019450682346141668
1,1,C,1.1559436947653743
2,1,C,0.38272712354283334
3,1,C,0.00021392712067414
4,1,C,0.44423460958085226
5,1,C,1.377069812461686
6,1,C,1.9799824974549554
1,2,C,1.0170215307092125
2,2,C,0.3139470657369108
3,2,C,0.0036540443554032853
4,2,C,0.48641743614550437
5,2,C,1.4142212387971869
6,2,C,1.986175939144255
1,3,C,0.9179968609607547
2,3,C,0.2665566278409074
3,3,C,0.009016517099134758
4,3,C,0.519307022323508
5,3,C,1.4420795294939195
6,3,C,1.990140036061585
1,4,C,0.8394434614253095
2,4,C,0.2300942702501071
3,4,C,0.015279056875972419
4,4,C,0.5473381427076471
5,4,C,1.4651140516928534
6,4,C,1.9929549762836907
1,5,C,0.7738620277177296
2,5,C,0.20052801164655532
3,5,C,0.022059190682766516
4,5,C,0.5722355793970464
5,5,C,1.485058145415328
6,5,C,1.9950387168674295
1,6,C,0.7174188421724267
2,6,C,0.17579990271593138
3,6,C,0.02916737260633384
4,6,C,0.5948873339246776
5,6,C,1.502801829878708
6,6,C,1.9966053897707945
1,1,D,0.0
2,1,D,0.41421356237309515
3,1,D,0.7320508075688772
4,1,D,1.0
5,1,D,1.2360679774997898
6,1,D,1.4494897427831779
1,2,D,-0.41421356237309515
2,2,D,0.0
3,2,D,0.31783724519578205
4,2,D,0.5857864376269049
5,2,D,0.8218544151266947
6,2,D,1.0352761804100827
1,3,D,-0.7320508075688772
2,3,D,-0.31783724519578205
3,3,D,0.0
4,3,D,0.2679491924311228
5,3,D,0.5040171699309126
6,3,D,0.7174389352143007
1,4,D,-1.0
2,4,D,-0.5857864376269049
3,4,D,-0.2679491924311228
4,4,D,0.0
5,4,D,0.2360679774997898
6,4,D,0.4494897427831779
1,5,D,-1.2360679774997898
2,5,D,-0.8218544151266947
3,5,D,-0.5040171699309126
4,5,D,-0.2360679774997898
5,5,D,0.0
6,5,D,0.21342176528338808
1,6,D,-1.4494897427831779
2,6,D,-1.0352761804100827
3,6,D,-0.7174389352143007
4,6,D,-0.4494897427831779
5,6,D,-0.21342176528338808
6,6,D,0.0
</div><div id="correlations" style="display: none;">Symbol1,Symbol2,Correlation
RTX,GOOG,-0.85
RTX,MSFT,-0.75
GOOG,MSFT,0.8
RTX,RTX,1.0
GOOG,GOOG,1.0
MSFT,MSFT,1.0
GOOG,RTX,-0.85
MSFT,RTX,-0.75
MSFT,GOOG,0.8
</div><div id="df" style="display: none;">date,x,y,color,categ,categ22
2024-01-01,1,0.28744546468394316,A,B,Category_A
2024-01-02,2,0.1493097385572918,B,B,Category_A
2024-01-03,3,0.7477655649611844,A,B,Category_A
2024-01-04,4,0.5944276837736112,B,B,Category_A
2024-01-05,5,0.4209120513600455,A,B,Category_A
2024-01-06,6,0.623461842891765,B,A,Category_A
2024-01-07,7,0.7011924253662256,A,A,Category_A
2024-01-08,8,0.3667766881420472,B,A,Category_A
2024-01-09,9,0.2127419226534375,A,A,Category_A
2024-01-10,10,0.9623397158815609,B,C,Category_A
2024-01-01,1,0.4403948814900035,A,A,Category_B
2024-01-02,2,0.7817545559114915,B,A,Category_B
2024-01-03,3,0.8607069766346133,A,A,Category_B
2024-01-04,4,0.8407939059073998,B,A,Category_B
2024-01-05,5,0.4953824035421598,A,A,Category_B
2024-01-06,6,0.2680858650942728,B,B,Category_B
2024-01-07,7,0.3895499562029605,A,B,Category_B
2024-01-08,8,0.012953878872641988,B,B,Category_B
2024-01-09,9,0.3586929450460915,A,B,Category_B
2024-01-10,10,0.18586587744537297,B,C,Category_B
</div>

<!-- ACTUAL CONTENT -->

<h1></h1>
<p></p>

    <h2>Returns_Over_Last_Few_Days</h2>
    <p></p>
    <div id="Returns_Over_Last_Few_Days"></div>

    <br><hr><br>
<h2>Line Chart</h2>
<p></p>

<!-- Controls -->
<div id="controls">
            <div style="margin: 10px;">
            <label for="categ22_select">categ22: </label>
            <select id="categ22_select" onchange="updateChart()">
                <option value="Category_A" selected>Category_A</option>
                <option value="Category_B">Category_B</option>
            </select>
        </div>
                <div style="margin: 10px;">
            <label for="categ_select">categ: </label>
            <select id="categ_select" onchange="updateChart()">
                <option value="B">B</option>
                <option value="A" selected>A</option>
                <option value="C">C</option>
            </select>
        </div>
        
</div>

<!-- Chart -->
<div id="pchart"></div>
<br><hr><br>
    <h2>Correlation_Matrix</h2>
    <p></p>
    <div id="Correlation_Matrix"></div>

    <br><hr><br>
<h2>3D Surface Chart of shapes</h2>
<p>This is a 3D surface chart.</p>       
<!-- Chart -->
<div id="threeD"></div>
<br><hr><br>


</body>
</html>
