<!DOCTYPE html>
<html>
<head>
    <title>External Format Examples</title>
    <meta charset="UTF-8">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@14.0.1/Arrow.es2015.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #$div_id {
            width: 100%;
            height: 600px;
        }
    </style>
        <style>
        .textblock-content {
            padding: 20px;
            margin: 10px 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .textblock-content h1 {
            font-size: 2em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .textblock-content h2 {
            font-size: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .textblock-content h3 {
            font-size: 1.25em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .textblock-content p {
            margin: 0.5em 0;
        }

        .textblock-content ul, .textblock-content ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }

        .textblock-content code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .textblock-content pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .textblock-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .textblock-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1em;
            margin-left: 0;
            color: #666;
        }

        .textblock-content a {
            color: #0066cc;
            text-decoration: none;
        }

        .textblock-content a:hover {
            text-decoration: underline;
        }

        .textblock-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }

        .textblock-content th, .textblock-content td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .textblock-content th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
    </style>


    <!-- external libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/d3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/c3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/export_renderers.min.js"></script>
</head>

<body>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<script type="module">
// Import parquet-wasm for Parquet file support
import * as parquet from 'https://unpkg.com/parquet-wasm@0.6.1/esm/parquet_wasm.js';

// Initialize parquet-wasm
await parquet.default();

// Make parquet available globally for loadDataset
window.parquetWasm = parquet;
window.parquetReady = true;
console.log('Parquet-wasm library loaded successfully');
</script>

<script>
// Helper function to wait for parquet-wasm to be loaded
function waitForParquet() {
    return new Promise(function(resolve) {
        if (window.parquetReady) {
            resolve();
            return;
        }
        var checkInterval = setInterval(function() {
            if (window.parquetReady) {
                clearInterval(checkInterval);
                resolve();
            }
        }, 50);
    });
}

// Centralized data loading function
// This function parses data from embedded or external sources and returns a Promise
// Supports CSV (embedded/external), JSON (embedded/external), and Parquet (external) formats
// Usage: loadDataset('dataLabel').then(function(data) { /* use data */ });
function loadDataset(dataLabel) {
    return new Promise(function(resolve, reject) {
        var dataElement = document.getElementById(dataLabel);
        if (!dataElement) {
            reject(new Error('Data element not found: ' + dataLabel));
            return;
        }

        var format = dataElement.getAttribute('data-format') || 'csv_embedded';
        var dataSrc = dataElement.getAttribute('data-src');

        // Handle external JSON files
        if (format === 'json_external' && dataSrc) {
            fetch(dataSrc)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(function(data) {
                    resolve(data);
                })
                .catch(function(error) {
                    console.error('Error loading external JSON:', error);
                    reject(error);
                });
            return;
        }

        // Handle external Parquet files
        if (format === 'parquet' && dataSrc) {
            // Wait for parquet-wasm to be loaded first
            waitForParquet()
                .then(function() {
                    return fetch(dataSrc);
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.arrayBuffer();
                })
                .then(function(arrayBuffer) {
                    // Use parquet-wasm to read the file
                    var uint8Array = new Uint8Array(arrayBuffer);

                    // readParquet returns an Arrow Table
                    var wasmTable = window.parquetWasm.readParquet(uint8Array);

                    // Convert to Arrow IPC stream
                    var ipcStream = wasmTable.intoIPCStream();

                    // Use Apache Arrow JS to read the IPC stream
                    var arrowTable = window.Arrow.tableFromIPC(ipcStream);

                    // Convert Arrow Table to array of JavaScript objects
                    var data = [];
                    for (var i = 0; i < arrowTable.numRows; i++) {
                        var row = {};
                        arrowTable.schema.fields.forEach(function(field) {
                            var column = arrowTable.getChild(field.name);
                            var value = column.get(i);

                            // Convert BigInt to Number (Arrow returns BigInt for Int64)
                            if (typeof value === 'bigint') {
                                value = Number(value);
                            }

                            row[field.name] = value;
                        });
                        data.push(row);
                    }

                    resolve(data);
                })
                .catch(function(error) {
                    console.error('Error loading external Parquet:', error);
                    reject(error);
                });
            return;
        }

        // Handle external CSV files
        if (format === 'csv_external' && dataSrc) {
            fetch(dataSrc)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.text();
                })
                .then(function(csvText) {
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            // Check for fatal errors only (not warnings)
                            var fatalErrors = results.errors.filter(function(err) {
                                return err.type !== 'Delimiter';
                            });

                            if (fatalErrors.length > 0) {
                                console.error('CSV parsing errors:', fatalErrors);
                                reject(fatalErrors);
                            } else if (results.data && results.data.length > 0) {
                                resolve(results.data);
                            } else {
                                reject(new Error('No data parsed from CSV'));
                            }
                        },
                        error: function(error) {
                            console.error('CSV parsing error:', error);
                            reject(error);
                        }
                    });
                })
                .catch(function(error) {
                    console.error('Error loading external CSV:', error);
                    reject(error);
                });
            return;
        }

        // Handle embedded data
        var dataText = dataElement.textContent.trim();

        if (format === 'json_embedded') {
            // Parse JSON data
            try {
                var data = JSON.parse(dataText);
                resolve(data);
            } catch (error) {
                console.error('JSON parsing error:', error);
                reject(error);
            }
        } else if (format === 'csv_embedded') {
            // Parse CSV data using PapaParse
            Papa.parse(dataText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Check for fatal errors only (not warnings)
                    // PapaParse includes non-fatal warnings in errors array
                    var fatalErrors = results.errors.filter(function(err) {
                        // Filter out delimiter detection warnings - these aren't fatal
                        // (common for single-column CSVs)
                        return err.type !== 'Delimiter';
                    });

                    if (fatalErrors.length > 0) {
                        console.error('CSV parsing errors:', fatalErrors);
                        reject(fatalErrors);
                    } else if (results.data && results.data.length > 0) {
                        resolve(results.data);
                    } else {
                        reject(new Error('No data parsed from CSV'));
                    }
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    reject(error);
                }
            });
        } else {
            reject(new Error('Unsupported data format: ' + format));
        }
    });
}

$(function(){

    // Configuration
    const X_COL = 'date';
    const Y_COL = 'value';
    const COLOR_COL = 'category';
    const FILTER_COLS = [];
    const COLOR_MAP = {'B': '#636efa', 'A': '#00cc96', 'C': '#EF553B'};
    const X_LABEL = 'Date';
    const Y_LABEL = 'Value';
                
    let allData = [];

    // Make it global so inline onchange can see it
    window.updateChart = function() {
        const filters = {};
        FILTER_COLS.forEach(col => {
            const select = document.getElementById(col + '_select');
            if (select) {
                filters[col] = select.value;
            }
        });

        const filteredData = allData.filter(row => {
            for (let col in filters) {
                if (String(row[col]) !== String(filters[col])) {
                    return false;
                }
            }
            return true;
        });

        const groupedData = {};
        filteredData.forEach(row => {
            const colorVal = row[COLOR_COL];
            if (!groupedData[colorVal]) {
                groupedData[colorVal] = [];
            }
            groupedData[colorVal].push(row);
        });

        const traces = [];
        for (let colorVal in groupedData) {
            const group = groupedData[colorVal];
            group.sort((a, b) => a[X_COL] - b[X_COL]);

            traces.push({
                x: group.map(row => row[X_COL]),
                y: group.map(row => row[Y_COL]),
                type: 'scatter',
                mode: 'lines+markers',
                name: colorVal,
                line: {
                    color: COLOR_MAP[colorVal] || '#000000',
                    width: 1
                },
                marker: { size: 1 }
            });
        }
        
        // Layout
        const layout = {
            xaxis: { title: X_LABEL || X_COL },
            yaxis: { title: Y_LABEL || Y_COL },
            hovermode: 'closest',
            showlegend: true
        };
        
        // Plot
        Plotly.newPlot('timeseries', traces, layout, {responsive: true});
    };

    // Load and parse CSV data using centralized parser
    loadDataset('df').then(function(data) {
        allData = data;
        updateChart();
    }).catch(function(error) {
        console.error('Error loading data for chart timeseries:', error);
    });
    // Initialize density toggle state
    window.showDensity_stock_scatter = true;
    
    // Load and parse CSV data using centralized parser
    loadDataset('stock_data').then(function(data) {
        window.allData_stock_scatter = data;

        // Initialize sliders and button after data is loaded
        $(function() {
                // Density toggle button
                document.getElementById('stock_scatter_density_toggle').addEventListener('click', function() {
                    window.showDensity_stock_scatter = !window.showDensity_stock_scatter;
                    this.textContent = window.showDensity_stock_scatter ? 'Hide Density Contours' : 'Show Density Contours';
                    updatePlotWithFilters_stock_scatter();
                });
                
                
                
            // Initial plot
            updatePlotWithFilters_stock_scatter();
        });
    }).catch(function(error) {
        console.error('Error loading data for chart stock_scatter:', error);
    });
    
    function updatePlot_stock_scatter(data) {
        var traces = [];
        
        // Group data by color column
var groups = {};
data.forEach(function(row) {
    var key = row.symbol;
    if (!groups[key]) groups[key] = [];
    groups[key].push(row);
});

// Create a trace for each group
Object.keys(groups).forEach(function(key) {
    var groupData = groups[key];
    traces.push({
        x: groupData.map(d => d.volume),
        y: groupData.map(d => d.price),
        mode: 'markers',
        name: key,
        marker: {
            size: 4,
            opacity: 0.6
        },
        type: 'scatter'
    });
});

// Density contours
if (window.showDensity_stock_scatter) {
    traces.push({
        x: data.map(d => d.volume),
        y: data.map(d => d.price),
        name: 'density',
        ncontours: 20,
        colorscale: 'Hot',
        reversescale: true,
        showscale: false,
        type: 'histogram2dcontour',
        showlegend: false
    });
}

// X marginal histogram
traces.push({
    x: data.map(d => d.volume),
    name: 'x density',
    marker: {color: 'rgba(128, 128, 128, 0.5)'},
    yaxis: 'y2',
    type: 'histogram',
    showlegend: false
});

// Y marginal histogram
traces.push({
    y: data.map(d => d.price),
    name: 'y density',
    marker: {color: 'rgba(128, 128, 128, 0.5)'},
    xaxis: 'x2',
    type: 'histogram',
    showlegend: false
});

        
        var layout = {
            title: 'Stock Price vs Volume',
            showlegend: true,
            autosize: true,
            hovermode: 'closest',
                xaxis: {
        title: 'Volume',
        domain: [0, 0.85],
        showgrid: true,
        zeroline: true
    },
    yaxis: {
        title: 'Price',
        domain: [0, 0.85],
        showgrid: true,
        zeroline: true
    },
    xaxis2: {
        domain: [0.85, 1],
        showgrid: false,
        zeroline: false
    },
    yaxis2: {
        domain: [0.85, 1],
        showgrid: false,
        zeroline: false
    },

            margin: {t: 100, r: 100, b: 100, l: 100}
        };
        
        Plotly.newPlot('stock_scatter', traces, layout, {responsive: true});
    }
    
        function updatePlotWithFilters_stock_scatter() {
        updatePlot_stock_scatter(window.allData_stock_scatter);
    }



});
</script>

<!-- DATASETS -->

<script type="text/plain" id="df" data-format="parquet" data-src="data/df.parquet"></script><script type="text/plain" id="stock_data" data-format="parquet" data-src="data/stock_data.parquet"></script>

<!-- ACTUAL CONTENT -->

<h1></h1>
<p></p>

    <div class="textblock-content">
        <h1>External Data Format Examples</h1>
<p>This page demonstrates different data storage formats available in JSPlots.</p>
<p>By default, data is embedded directly in the HTML file. For larger datasets, external formats can be more efficient.</p>

    </div>

    <br><hr><br>
    <div class="textblock-content">
        <h2>Available Data Formats</h2>
<h3>JSON External (:json_external)</h3>
<p>Data is stored as .json files in a data/ subdirectory.</p>
<ul>
    <li><strong>Pros:</strong> Human-readable, widely compatible</li>
    <li><strong>Cons:</strong> Larger file size than Parquet</li>
</ul>

<h3>Parquet (:parquet)</h3>
<p>Data is stored as .parquet files in a data/ subdirectory.</p>
<ul>
    <li><strong>Pros:</strong> Binary format, smallest size, fastest loading</li>
    <li><strong>Cons:</strong> Not human-readable</li>
    <li><strong>Recommended:</strong> Best choice for production use</li>
</ul>

<h3>CSV External (:csv_external)</h3>
<p>Data is stored as .csv files in a data/ subdirectory.</p>
<ul>
    <li><strong>Pros:</strong> Human-readable, can be opened in spreadsheet applications</li>
    <li><strong>Cons:</strong> Moderate file size</li>
</ul>

    </div>

    <br><hr><br>
<h2>Time Series Data</h2>
<p></p>

<!-- Controls -->
<div id="controls">
    
</div>

<!-- Chart -->
<div id="timeseries"></div>
<br><hr><br>
<h2>Stock Price vs Volume</h2>
<p></p>

<div style="margin: 20px 0;">
    <button id="stock_scatter_density_toggle" style="padding: 5px 15px; cursor: pointer;">
        Hide Density Contours
    </button>
</div>


<!-- Chart -->
<div id="stock_scatter"></div>
<br><hr><br>
    <div class="textblock-content">
        <h2>Usage Notes</h2>
<p>This example uses Parquet format (the recommended format for production use).</p>
<p>To use external formats, simply set the <code>dataformat</code> parameter when creating a JSPlotPage:</p>
<pre><code>page = JSPlotPage(
    data_dict,
    plot_elements,
    dataformat = :parquet  # or :json_external, :csv_external
)</code></pre>
<p><strong>Important:</strong> When using external formats, you must use the provided launcher scripts (open.sh or open.bat) to avoid CORS errors when viewing files locally.</p>

    </div>

    <br><hr><br>
    <div class="textblock-content">
        <h2>Summary</h2>
<p>This page demonstrated external data formats:</p>
<ul>
    <li><strong>JSON External:</strong> Human-readable, widely compatible</li>
    <li><strong>Parquet:</strong> Binary format, smallest size, fastest loading (recommended)</li>
    <li><strong>CSV External:</strong> Human-readable, spreadsheet-compatible</li>
</ul>
<p><strong>File size comparison:</strong> Parquet is typically the smallest, followed by JSON, then CSV.</p>
<p><strong>Recommendation:</strong> Use Parquet format for production applications with larger datasets.</p>

    </div>

    <br><hr><br>


<hr><p align="right"><small>This page was created using <a href="https://github.com/s-baumann/JSPlots.jl">JSPlots.jl</a>.</small></p>
</body>
</html>
